<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiring Dashboard - Head of Customer Success</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .section-content.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        .chevron {
            transition: transform 0.2s ease;
        }
        .chevron.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans antialiased">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-900">Hiring Dashboard</h1>
                        <p class="text-xs text-slate-500">Head of Customer Success</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="hidden sm:inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>
                        Live
                    </span>
                    <!-- Auto-refresh indicator -->
                    <span id="auto-refresh-indicator" class="hidden sm:inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="auto-refresh-countdown">15:00</span>
                    </span>
                    <button onclick="refreshAllData()" id="refresh-btn" class="inline-flex items-center gap-2 px-3 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium rounded-lg transition-colors">
                        <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span id="refresh-text">Refresh Data</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if error %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-8">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <h3 class="text-sm font-medium text-red-800">Error loading data</h3>
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if metrics %}
        <!-- Section 1: Overall Metrics -->
        <section class="mb-6">
            <button onclick="toggleSection('section1')" class="w-full bg-white rounded-xl border border-slate-200 p-5 shadow-sm hover:bg-slate-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <h2 class="text-lg font-semibold text-slate-900">Section 1: Overall Metrics</h2>
                            <p class="text-sm text-slate-500">{{ metrics.total_applications }} total applications</p>
                        </div>
                    </div>
                    <svg id="chevron-section1" class="chevron w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </button>

            <div id="section1" class="section-content">
                <div class="mt-4 space-y-6">
                    <!-- Total Applications Card -->
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Applications</p>
                                <p class="text-5xl font-bold text-slate-900 mt-2">{{ metrics.total_applications }}</p>
                                <p class="text-xs text-slate-400 mt-1">excluding test entries</p>
                            </div>
                            <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center">
                                <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Source Breakdown Cards -->
                    <div>
                        <h3 class="text-sm font-medium text-slate-700 mb-4">Applications by Source</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                            {% for source, count in metrics.source_breakdown.items() %}
                            <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm hover:border-slate-300 transition-colors">
                                <p class="text-2xl font-bold text-slate-900">{{ count }}</p>
                                <p class="text-sm text-slate-600 mt-1 truncate" title="{{ source }}">{{ source }}</p>
                                <div class="mt-3 h-1 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-slate-400 rounded-full" style="width: {{ (count / metrics.total_applications * 100)|round(1) }}%"></div>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">{{ (count / metrics.total_applications * 100)|round(1) }}%</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Level Breakdown Table -->
                    <div>
                        <h3 class="text-sm font-medium text-slate-700 mb-4">Applications by Filter Level</h3>
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-3">Level</th>
                                        <th class="text-right text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-3">Count</th>
                                        <th class="text-right text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-3">Percentage</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-3 hidden sm:table-cell">Distribution</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for level, count in metrics.level_breakdown.items() %}
                                    <tr class="hover:bg-slate-50 transition-colors">
                                        <td class="px-6 py-4">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm font-medium
                                                {% if level == 'Level 5' %}bg-emerald-100 text-emerald-800
                                                {% elif level == 'Level 4' %}bg-blue-100 text-blue-800
                                                {% elif level == 'Level 3' %}bg-amber-100 text-amber-800
                                                {% else %}bg-slate-100 text-slate-800{% endif %}">
                                                {{ level }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <span class="text-lg font-semibold text-slate-900">{{ count }}</span>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <span class="text-sm text-slate-600">{{ (count / metrics.total_applications * 100)|round(1) }}%</span>
                                        </td>
                                        <td class="px-6 py-4 hidden sm:table-cell">
                                            <div class="w-full max-w-xs h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full
                                                    {% if level == 'Level 5' %}bg-emerald-500
                                                    {% elif level == 'Level 4' %}bg-blue-500
                                                    {% elif level == 'Level 3' %}bg-amber-500
                                                    {% else %}bg-slate-400{% endif %}"
                                                    style="width: {{ (count / metrics.total_applications * 100)|round(1) }}%">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Top-Tier MBA & UG Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top-Tier MBA Card -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Top-Tier MBA</p>
                                        <p class="text-3xl font-bold text-slate-900 mt-1">{{ metrics.top_tier_mba_count }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-6 h-6 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            {% if metrics.mba_institutions %}
                            <div class="max-h-64 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 sticky top-0">
                                        <tr>
                                            <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-2">Institution</th>
                                            <th class="text-right text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-2">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        {% for institution, count in metrics.mba_institutions.items() %}
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-3 text-sm text-slate-700">{{ institution }}</td>
                                            <td class="px-6 py-3 text-right">
                                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-violet-100 text-violet-700 text-sm font-semibold">{{ count }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="p-6 text-center text-slate-500 text-sm">No top-tier MBA institutions found</div>
                            {% endif %}
                        </div>

                        <!-- Top-Tier UG Card -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Top-Tier UG <span class="text-slate-400">(no Top-Tier MBA)</span></p>
                                        <p class="text-3xl font-bold text-slate-900 mt-1">{{ metrics.top_tier_ug_count }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            {% if metrics.ug_institutions %}
                            <div class="max-h-64 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 sticky top-0">
                                        <tr>
                                            <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-2">Institution</th>
                                            <th class="text-right text-xs font-semibold text-slate-600 uppercase tracking-wider px-6 py-2">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        {% for institution, count in metrics.ug_institutions.items() %}
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-3 text-sm text-slate-700">{{ institution }}</td>
                                            <td class="px-6 py-3 text-right">
                                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-cyan-100 text-cyan-700 text-sm font-semibold">{{ count }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="p-6 text-center text-slate-500 text-sm">No top-tier UG institutions found</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Video Submissions -->
        <section class="mb-6">
            <button onclick="toggleSection('section2')" class="w-full bg-white rounded-xl border border-slate-200 p-5 shadow-sm hover:bg-slate-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <h2 class="text-lg font-semibold text-slate-900">Section 2: Video Submissions</h2>
                            <p class="text-sm text-slate-500">{{ metrics.video_count }} candidates submitted videos</p>
                        </div>
                    </div>
                    <svg id="chevron-section2" class="chevron w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </button>

            <div id="section2" class="section-content">
                <div class="mt-4 space-y-6">
                    <!-- Video Submissions Count -->
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Video Submissions</p>
                                <p class="text-5xl font-bold text-indigo-600 mt-2">{{ metrics.video_count }}</p>
                                <p class="text-xs text-slate-400 mt-1">candidates have submitted video links</p>
                            </div>
                            <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center">
                                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Video Breakdown Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- By Level -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50">
                                <h3 class="text-sm font-semibold text-slate-700">By Filter Level</h3>
                            </div>
                            <div class="p-4">
                                <table class="w-full">
                                    <tbody class="divide-y divide-slate-100">
                                        {% for level, count in metrics.video_level_breakdown.items() %}
                                        <tr>
                                            <td class="py-2">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                                                    {% if level == 'Level 5' %}bg-emerald-100 text-emerald-800
                                                    {% elif level == 'Level 4' %}bg-blue-100 text-blue-800
                                                    {% elif level == 'Level 3' %}bg-amber-100 text-amber-800
                                                    {% else %}bg-slate-100 text-slate-800{% endif %}">
                                                    {{ level }}
                                                </span>
                                            </td>
                                            <td class="py-2 text-right">
                                                <span class="text-lg font-semibold text-slate-900">{{ count }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- By MBA Status -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50">
                                <h3 class="text-sm font-semibold text-slate-700">By MBA Status</h3>
                            </div>
                            <div class="p-4">
                                <table class="w-full">
                                    <tbody class="divide-y divide-slate-100">
                                        {% for status, count in metrics.video_mba_breakdown.items() %}
                                        <tr>
                                            <td class="py-2">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                                                    {% if status == 'Top-Tier MBA' %}bg-violet-100 text-violet-800
                                                    {% elif status == 'Other MBA' %}bg-slate-100 text-slate-800
                                                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                                                    {{ status }}
                                                </span>
                                            </td>
                                            <td class="py-2 text-right">
                                                <span class="text-lg font-semibold text-slate-900">{{ count }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- By Stage 1 Status -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden" id="stage-status-card">
                            <div class="p-4 border-b border-slate-100 bg-slate-50">
                                <h3 class="text-sm font-semibold text-slate-700">Stage 1 Review Status</h3>
                            </div>
                            <div class="p-4">
                                <table class="w-full">
                                    <tbody class="divide-y divide-slate-100">
                                        <tr>
                                            <td class="py-2">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-green-100 text-green-800">
                                                    Selected
                                                </span>
                                            </td>
                                            <td class="py-2 text-right">
                                                <span class="text-lg font-semibold text-slate-900" id="count-selected">{{ metrics.video_stage_breakdown.get('Selected', 0) }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="py-2">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-red-100 text-red-800">
                                                    Rejected
                                                </span>
                                            </td>
                                            <td class="py-2 text-right">
                                                <span class="text-lg font-semibold text-slate-900" id="count-rejected">{{ metrics.video_stage_breakdown.get('Rejected', 0) }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="py-2">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    Not Reviewed
                                                </span>
                                            </td>
                                            <td class="py-2 text-right">
                                                <span class="text-lg font-semibold text-slate-900" id="count-not-reviewed">{{ metrics.video_stage_breakdown.get('Not Reviewed', 0) }}</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Top-Tier MBA Institutions (Video Submitters) -->
                    {% if metrics.video_mba_institutions %}
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50">
                            <h3 class="text-sm font-semibold text-slate-700">Top-Tier MBA Institutions (Video Submitters)</h3>
                        </div>
                        <div class="p-4">
                            <div class="flex flex-wrap gap-2">
                                {% for institution, count in metrics.video_mba_institutions.items() %}
                                <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-violet-50 border border-violet-200">
                                    <span class="text-sm text-violet-900">{{ institution }}</span>
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-200 text-violet-800 text-xs font-semibold">{{ count }}</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Section 3: Interactive Table -->
        <section class="mb-6">
            <button onclick="toggleSection('section3')" class="w-full bg-white rounded-xl border border-slate-200 p-5 shadow-sm hover:bg-slate-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div class="text-left">
                            <h2 class="text-lg font-semibold text-slate-900">Section 3: Candidate Review</h2>
                            <p class="text-sm text-slate-500" id="section3-subtitle">Loading candidates...</p>
                        </div>
                    </div>
                    <svg id="chevron-section3" class="chevron w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </button>

            <div id="section3" class="section-content">
                <div class="mt-4">
                    <!-- Filter Controls -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span id="filter-status-text" class="text-sm text-slate-500"></span>
                        </div>
                        <button onclick="clearAllFilters()" id="clear-filters-btn" class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 rounded-lg transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Clear Filters
                        </button>
                    </div>
                    <!-- Table Container -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full" id="candidates-table">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Name / Email</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Level</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Experience</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">MBA</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Video</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Resume</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Profile</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">AI Eval</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">AI Rec</th>
                                        <th class="text-center text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Report</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3 min-w-[250px]">Reviewer Comments</th>
                                        <th class="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-4 py-3">Stage 1 Status</th>
                                    </tr>
                                    <!-- Filter Row -->
                                    <tr class="bg-slate-100 border-b border-slate-200">
                                        <td class="px-4 py-2">
                                            <input type="text" id="filter-name" onchange="applyFilters()" placeholder="Search name..." class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                        </td>
                                        <td class="px-4 py-2">
                                            <select id="filter-level" onchange="applyFilters()" class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">All Levels</option>
                                                <option value="Level 5">Level 5</option>
                                                <option value="Level 4">Level 4</option>
                                                <option value="Level 3">Level 3</option>
                                            </select>
                                        </td>
                                        <td class="px-4 py-2"><!-- No filter --></td>
                                        <td class="px-4 py-2">
                                            <select id="filter-mba" onchange="applyFilters()" class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">All MBA</option>
                                                <option value="top-tier">Top-Tier MBA</option>
                                                <option value="other-mba">Other MBA</option>
                                                <option value="no-mba">No MBA</option>
                                            </select>
                                        </td>
                                        <td class="px-4 py-2"><!-- No filter --></td>
                                        <td class="px-4 py-2"><!-- No filter --></td>
                                        <td class="px-4 py-2"><!-- No filter --></td>
                                        <td class="px-4 py-2"><!-- No filter --></td>
                                        <td class="px-4 py-2"><!-- AI Eval --></td>
                                        <td class="px-4 py-2">
                                            <select id="filter-ai-rec" onchange="applyFilters()" class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">All AI Rec</option>
                                                <option value="Strong Yes">Strong Yes</option>
                                                <option value="Yes">Yes</option>
                                                <option value="Maybe">Maybe</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                        <td class="px-4 py-2"><!-- Report --></td>
                                        <td class="px-4 py-2">
                                            <select id="filter-status" onchange="applyFilters()" class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">All Status</option>
                                                <option value="Selected">Selected</option>
                                                <option value="Rejected">Rejected</option>
                                                <option value="Not Reviewed">Not Reviewed</option>
                                            </select>
                                        </td>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="candidates-tbody">
                                    <tr>
                                        <td colspan="12" class="px-4 py-8 text-center text-slate-500">
                                            <div class="flex items-center justify-center gap-2">
                                                <svg class="animate-spin w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Loading candidates...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PDF Preview Modal -->
        <div id="pdf-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900" id="pdf-modal-title">Resume Preview</h3>
                    <button onclick="closePdfModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 p-4">
                    <iframe id="pdf-iframe" class="w-full h-full rounded-lg border border-slate-200" src=""></iframe>
                </div>
            </div>
        </div>

        <!-- Profile Viewer Modal -->
        <div id="profile-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900" id="profile-modal-title">Candidate Profile</h3>
                    <button onclick="closeProfileModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="profile-content" class="space-y-2 font-mono text-sm"></div>
                </div>
            </div>
        </div>
        {% endif %}
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 bg-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <p class="text-center text-sm text-slate-500">
                e-GMAT Hiring Dashboard â€¢ Data synced from Airtable
            </p>
        </div>
    </footer>

    <script>
        let candidatesData = [];
        let filteredCandidatesData = [];
        let autoRefreshInterval = null;
        let countdownInterval = null;
        let countdownSeconds = 15 * 60; // 15 minutes in seconds

        // Auto-refresh cutoff date: January 30, 2026
        const AUTO_REFRESH_CUTOFF = new Date('2026-01-30T23:59:59');

        // Filter storage key for localStorage
        const FILTER_STORAGE_KEY = 'hiring-dashboard-filters';

        // Check if auto-refresh should be active
        function isAutoRefreshActive() {
            const now = new Date();
            return now <= AUTO_REFRESH_CUTOFF;
        }

        // Initialize auto-refresh
        function initAutoRefresh() {
            if (!isAutoRefreshActive()) {
                // Hide the auto-refresh indicator if past cutoff
                const indicator = document.getElementById('auto-refresh-indicator');
                if (indicator) {
                    indicator.classList.add('hidden');
                    indicator.classList.remove('sm:inline-flex');
                }
                return;
            }

            // Show auto-refresh indicator
            const indicator = document.getElementById('auto-refresh-indicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }

            // Start countdown
            countdownSeconds = 15 * 60;
            updateCountdownDisplay();

            // Countdown timer (every second)
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();

                if (countdownSeconds <= 0) {
                    // Trigger refresh
                    performAutoRefresh();
                }
            }, 1000);
        }

        // Update countdown display
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('auto-refresh-countdown');
            if (countdownEl) {
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Perform auto-refresh
        async function performAutoRefresh() {
            // Check again if auto-refresh is still active
            if (!isAutoRefreshActive()) {
                clearInterval(countdownInterval);
                const indicator = document.getElementById('auto-refresh-indicator');
                if (indicator) {
                    indicator.classList.add('hidden');
                }
                return;
            }

            // Reset countdown
            countdownSeconds = 15 * 60;

            // Refresh data without page reload
            try {
                await loadCandidates();
                showToast('Data auto-refreshed', 'success');
            } catch (error) {
                console.error('Auto-refresh failed:', error);
            }
        }

        // Load filters from localStorage
        function loadFilters() {
            try {
                const saved = localStorage.getItem(FILTER_STORAGE_KEY);
                if (saved) {
                    const filters = JSON.parse(saved);
                    if (filters.name) document.getElementById('filter-name').value = filters.name;
                    if (filters.level) document.getElementById('filter-level').value = filters.level;
                    if (filters.mba) document.getElementById('filter-mba').value = filters.mba;
                    if (filters.status) document.getElementById('filter-status').value = filters.status;
                }
            } catch (e) {
                console.error('Error loading filters:', e);
            }
        }

        // Save filters to localStorage
        function saveFilters() {
            const filters = {
                name: document.getElementById('filter-name').value,
                level: document.getElementById('filter-level').value,
                mba: document.getElementById('filter-mba').value,
                status: document.getElementById('filter-status').value
            };
            localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(filters));
        }

        // Apply filters to candidates data
        function applyFilters() {
            saveFilters();

            const nameFilter = document.getElementById('filter-name').value.toLowerCase();
            const levelFilter = document.getElementById('filter-level').value;
            const mbaFilter = document.getElementById('filter-mba').value;
            const statusFilter = document.getElementById('filter-status').value;
            const aiRecFilter = document.getElementById('filter-ai-rec') ? document.getElementById('filter-ai-rec').value : '';

            filteredCandidatesData = candidatesData.filter(candidate => {
                // Name filter
                if (nameFilter) {
                    const name = (candidate.name || '').toLowerCase();
                    const email = (candidate.email || '').toLowerCase();
                    if (!name.includes(nameFilter) && !email.includes(nameFilter)) {
                        return false;
                    }
                }

                // Level filter
                if (levelFilter && candidate.level !== levelFilter) {
                    return false;
                }

                // MBA filter
                if (mbaFilter) {
                    const isTopTier = candidate.is_top_tier_mba === 'Yes';
                    const hasMba = candidate.has_mba === 'Yes';

                    if (mbaFilter === 'top-tier' && !isTopTier) return false;
                    if (mbaFilter === 'other-mba' && (!hasMba || isTopTier)) return false;
                    if (mbaFilter === 'no-mba' && hasMba) return false;
                }

                // AI Rec filter
                if (aiRecFilter) {
                    if (candidate.ai_rec !== aiRecFilter) return false;
                }

                // Status filter
                if (statusFilter) {
                    const candidateStatus = candidate.stage_1_status || 'Not Reviewed';
                    if (statusFilter === 'Not Reviewed') {
                        if (candidateStatus && candidateStatus !== '' && candidateStatus !== 'Not Reviewed') return false;
                    } else if (candidateStatus !== statusFilter) {
                        return false;
                    }
                }

                return true;
            });

            renderCandidatesTable();
            updateFilterStatus();
        }

        // Update filter status text
        function updateFilterStatus() {
            const total = candidatesData.length;
            const filtered = filteredCandidatesData.length;
            const statusText = document.getElementById('filter-status-text');
            const clearBtn = document.getElementById('clear-filters-btn');

            const hasFilters = document.getElementById('filter-name').value ||
                              document.getElementById('filter-level').value ||
                              document.getElementById('filter-mba').value ||
                              document.getElementById('filter-status').value ||
                              (document.getElementById('filter-ai-rec') ? document.getElementById('filter-ai-rec').value : '');

            if (hasFilters) {
                statusText.textContent = `Showing ${filtered} of ${total} candidates`;
                clearBtn.classList.remove('hidden');
            } else {
                statusText.textContent = '';
                clearBtn.classList.add('hidden');
            }
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-level').value = '';
            document.getElementById('filter-mba').value = '';
            document.getElementById('filter-status').value = '';
            localStorage.removeItem(FILTER_STORAGE_KEY);
            applyFilters();
        }

        // Helper function to escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const chevron = document.getElementById('chevron-' + sectionId);

            content.classList.toggle('expanded');
            chevron.classList.toggle('rotated');
        }

        // Load candidates for Section 3
        async function loadCandidates() {
            try {
                const response = await fetch('api/video-submitters');
                candidatesData = await response.json();

                document.getElementById('section3-subtitle').textContent =
                    `${candidatesData.length} candidates with video submissions`;

                // Apply filters (which will also render the table)
                applyFilters();
            } catch (error) {
                console.error('Error loading candidates:', error);
                document.getElementById('candidates-tbody').innerHTML = `
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-red-500">
                            Error loading candidates: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderCandidatesTable() {
            const tbody = document.getElementById('candidates-tbody');

            if (filteredCandidatesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-slate-500">
                            ${candidatesData.length === 0 ? 'No video submissions found' : 'No candidates match the current filters'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCandidatesData.map((candidate, index) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <!-- Name / Email -->
                    <td class="px-4 py-3">
                        <div class="font-medium text-slate-900">${candidate.name || 'N/A'}</div>
                        <div class="text-sm text-slate-500">${candidate.email}</div>
                    </td>

                    <!-- Level -->
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                            ${candidate.level === 'Level 5' ? 'bg-emerald-100 text-emerald-800' :
                              candidate.level === 'Level 4' ? 'bg-blue-100 text-blue-800' :
                              candidate.level === 'Level 3' ? 'bg-amber-100 text-amber-800' :
                              'bg-slate-100 text-slate-800'}">
                            ${candidate.level || 'N/A'}
                        </span>
                    </td>

                    <!-- Experience -->
                    <td class="px-4 py-3">
                        <div class="text-sm text-slate-900">${candidate.total_exp || 'N/A'} yrs</div>
                        <div class="text-xs text-slate-500">Rel: ${candidate.relevant_exp || 'N/A'} yrs</div>
                    </td>

                    <!-- MBA -->
                    <td class="px-4 py-3">
                        ${candidate.is_top_tier_mba === 'Yes' ?
                            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-violet-100 text-violet-800 mb-1">Top-Tier</span><br>` :
                            candidate.has_mba === 'Yes' ?
                            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600 mb-1">MBA</span><br>` : ''}
                        <span class="text-sm text-slate-700">${candidate.mba_college && candidate.mba_college !== 'N/A' ? candidate.mba_college : (candidate.has_mba === 'Yes' ? 'MBA' : 'No MBA')}</span>
                    </td>

                    <!-- Video Link -->
                    <td class="px-4 py-3 text-center">
                        <a href="${candidate.video_link}" target="_blank"
                           class="inline-flex items-center justify-center w-9 h-9 bg-indigo-100 hover:bg-indigo-200 rounded-lg transition-colors"
                           title="Watch Video">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </a>
                    </td>

                    <!-- Resume PDF -->
                    <td class="px-4 py-3 text-center">
                        ${candidate.pdf_url ? `
                            <button onclick="openPdfModal('${candidate.pdf_url}', '${candidate.name}')"
                                class="inline-flex items-center justify-center w-9 h-9 bg-red-100 hover:bg-red-200 rounded-lg transition-colors"
                                title="View Resume">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </button>
                        ` : '<span class="text-slate-400 text-xs">No PDF</span>'}
                    </td>

                    <!-- Profile Viewer -->
                    <td class="px-4 py-3 text-center">
                        <button onclick="openProfileModal(${index})"
                            class="inline-flex items-center justify-center w-9 h-9 bg-cyan-100 hover:bg-cyan-200 rounded-lg transition-colors"
                            title="View Full Profile">
                            <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </button>
                    </td>

                    <!-- AI Eval Score -->
                    <td class="px-4 py-3 text-center">
                        ${candidate.ai_eval ?
                            `<div class="text-sm font-semibold text-slate-900">${candidate.ai_eval.toFixed(2)}</div>
                             <div class="text-xs text-slate-500">${candidate.ai_doer_prob ? (candidate.ai_doer_prob * 100).toFixed(0) + '%' : '-'} doer</div>
                             <button onclick="triggerEvaluation('${candidate.id}', this, true)"
                                class="inline-flex items-center gap-1 px-1.5 py-0.5 mt-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs rounded">
                                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>Re-run
                             </button>` :
                            (candidate.has_transcript ?
                                `<button onclick="triggerEvaluation('${candidate.id}', this)"
                                    class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs font-medium rounded-lg transition-colors">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    </svg>
                                    Evaluate
                                </button>` :
                                `<span class="text-slate-400 text-xs">No transcript</span>`)
                        }
                    </td>

                    <!-- AI Recommendation -->
                    <td class="px-4 py-3 text-center">
                        ${candidate.ai_rec ?
                            `<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                                ${candidate.ai_rec === 'Strong Yes' ? 'bg-emerald-100 text-emerald-800' :
                                  candidate.ai_rec === 'Yes' ? 'bg-green-100 text-green-800' :
                                  candidate.ai_rec === 'Maybe' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800'}">
                                ${candidate.ai_rec === 'Strong Yes' ? 'â˜…â˜…â˜… ' : candidate.ai_rec === 'Yes' ? 'â˜…â˜… ' : candidate.ai_rec === 'Maybe' ? 'â˜… ' : ''}${candidate.ai_rec}
                            </span>` :
                            '<span class="text-slate-400 text-xs">-</span>'}
                    </td>

                    <!-- AI Report -->
                    <td class="px-4 py-3 text-center">
                        ${candidate.ai_report_url ?
                            `<a href="${candidate.ai_report_url}" target="_blank"
                                class="inline-flex items-center justify-center w-9 h-9 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors"
                                title="View AI Report">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </a>` :
                            '<span class="text-slate-400 text-xs">-</span>'}
                    </td>

                    <!-- Reviewer Comments -->
                    <td class="px-4 py-3">
                        <div class="relative">
                            <textarea
                                id="comments-${candidate.id}"
                                data-record-id="${candidate.id}"
                                data-original-value="${escapeHtml(candidate.reviewer_comments || '')}"
                                onblur="saveComments('${candidate.id}', this)"
                                class="w-full min-w-[220px] px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors resize-y"
                                rows="2"
                                placeholder="Add comments...">${escapeHtml(candidate.reviewer_comments || '')}</textarea>
                            <div id="comments-status-${candidate.id}" class="hidden absolute -top-2 -right-2">
                                <span class="flex h-4 w-4">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-4 w-4 bg-indigo-500"></span>
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- Stage 1 Status -->
                    <td class="px-4 py-3">
                        <select onchange="updateStatus('${candidate.id}', this.value, this)"
                            data-original-value="${candidate.stage_1_status || ''}"
                            class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors
                                ${candidate.stage_1_status === 'Selected' ? 'bg-green-50 border-green-300 text-green-800' :
                                  candidate.stage_1_status === 'Rejected' ? 'bg-red-50 border-red-300 text-red-800' :
                                  'bg-yellow-50 border-yellow-300 text-yellow-800'}">
                            <option value="" ${!candidate.stage_1_status ? 'selected' : ''}>Not Reviewed</option>
                            <option value="Selected" ${candidate.stage_1_status === 'Selected' ? 'selected' : ''}>Selected</option>
                            <option value="Rejected" ${candidate.stage_1_status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        // PDF Modal
        function openPdfModal(pdfUrl, name) {
            document.getElementById('pdf-modal-title').textContent = `Resume: ${name}`;
            document.getElementById('pdf-iframe').src = pdfUrl;
            document.getElementById('pdf-modal').classList.remove('hidden');
            document.getElementById('pdf-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closePdfModal() {
            document.getElementById('pdf-modal').classList.add('hidden');
            document.getElementById('pdf-modal').classList.remove('flex');
            document.getElementById('pdf-iframe').src = '';
            document.body.style.overflow = '';
        }

        // Profile Modal
        function openProfileModal(index) {
            const candidate = candidatesData[index];
            document.getElementById('profile-modal-title').textContent = `Profile: ${candidate.name}`;

            const fields = candidate.all_fields;
            const profileHtml = Object.entries(fields).map(([key, value]) => {
                // Format value based on type
                let displayValue = value;
                if (Array.isArray(value)) {
                    if (value.length > 0 && value[0].url) {
                        // Attachment field
                        displayValue = value.map(v => v.filename || v.url).join(', ');
                    } else {
                        displayValue = JSON.stringify(value);
                    }
                } else if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                }

                return `
                    <div class="flex border-b border-slate-100 py-2">
                        <span class="w-1/3 text-slate-500 font-medium">${key}:</span>
                        <span class="w-2/3 text-slate-900 break-words">${displayValue || '<span class="text-slate-400 italic">empty</span>'}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('profile-content').innerHTML = profileHtml;
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('profile-modal').classList.remove('flex');
            document.body.style.overflow = '';
        }

        // Update Status
        
        // Trigger AI Evaluation
        async function triggerEvaluation(recordId, buttonElement, isRerun = false) {
            // Show loading state
            const originalHtml = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            buttonElement.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch('api/trigger-evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId, force_rerun: isRerun })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Evaluation completed successfully', 'success');
                    // Refresh the data to show updated values
                    await loadCandidates();
                } else {
                    showToast(result.error || 'Evaluation failed', 'error');
                    buttonElement.innerHTML = originalHtml;
                    buttonElement.disabled = false;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Evaluation error:', error);
                showToast('Failed to trigger evaluation', 'error');
                buttonElement.innerHTML = originalHtml;
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function updateStatus(recordId, newStatus, selectElement) {
            const originalValue = selectElement.getAttribute('data-original-value') || '';
            selectElement.disabled = true;

            try {
                const response = await fetch('api/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId, status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    // Update Section 2 counts in real-time
                    updateSection2StageCounts(originalValue, newStatus);

                    // Update local data
                    const candidate = candidatesData.find(c => c.id === recordId);
                    if (candidate) {
                        candidate.stage_1_status = newStatus;
                    }

                    // Update select styling
                    selectElement.className = selectElement.className.replace(/bg-\w+-50|border-\w+-300|text-\w+-800/g, '');
                    if (newStatus === 'Selected') {
                        selectElement.classList.add('bg-green-50', 'border-green-300', 'text-green-800');
                    } else if (newStatus === 'Rejected') {
                        selectElement.classList.add('bg-red-50', 'border-red-300', 'text-red-800');
                    } else {
                        selectElement.classList.add('bg-yellow-50', 'border-yellow-300', 'text-yellow-800');
                    }

                    selectElement.setAttribute('data-original-value', newStatus);

                    // Show success feedback
                    showToast('Status updated successfully', 'success');
                } else {
                    throw new Error(result.error || 'Update failed');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                selectElement.value = originalValue;
                showToast('Failed to update status: ' + error.message, 'error');
            } finally {
                selectElement.disabled = false;
            }
        }

        // Save Reviewer Comments
        async function saveComments(recordId, textareaElement) {
            const newComments = textareaElement.value;
            const originalValue = textareaElement.getAttribute('data-original-value') || '';

            // Skip if no changes
            if (newComments === originalValue) {
                return;
            }

            const statusIndicator = document.getElementById(`comments-status-${recordId}`);
            statusIndicator.classList.remove('hidden');

            try {
                const response = await fetch('api/update-comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId, comments: newComments })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    const candidate = candidatesData.find(c => c.id === recordId);
                    if (candidate) {
                        candidate.reviewer_comments = newComments;
                    }

                    // Update original value
                    textareaElement.setAttribute('data-original-value', newComments);

                    // Visual feedback - green border flash
                    textareaElement.classList.remove('border-slate-200');
                    textareaElement.classList.add('border-green-500');
                    setTimeout(() => {
                        textareaElement.classList.remove('border-green-500');
                        textareaElement.classList.add('border-slate-200');
                    }, 1500);

                    showToast('Comments saved', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save comments');
                }
            } catch (error) {
                console.error('Error saving comments:', error);
                // Revert to original value
                textareaElement.value = originalValue;
                textareaElement.classList.remove('border-slate-200');
                textareaElement.classList.add('border-red-500');
                setTimeout(() => {
                    textareaElement.classList.remove('border-red-500');
                    textareaElement.classList.add('border-slate-200');
                }, 1500);
                showToast('Failed to save comments: ' + error.message, 'error');
            } finally {
                statusIndicator.classList.add('hidden');
            }
        }

        // Toast notification
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-y-0 opacity-100
                ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    ${type === 'success' ?
                        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'}
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePdfModal();
                closeProfileModal();
            }
        });

        // Close modals on backdrop click
        document.getElementById('pdf-modal').addEventListener('click', function(e) {
            if (e.target === this) closePdfModal();
        });
        document.getElementById('profile-modal').addEventListener('click', function(e) {
            if (e.target === this) closeProfileModal();
        });

        // Refresh all data
        async function refreshAllData() {
            const btn = document.getElementById('refresh-btn');
            const icon = document.getElementById('refresh-icon');
            const text = document.getElementById('refresh-text');

            btn.disabled = true;
            icon.classList.add('animate-spin');
            text.textContent = 'Refreshing...';

            try {
                // Reload the page to get fresh metrics
                window.location.reload();
            } catch (error) {
                console.error('Error refreshing:', error);
                showToast('Failed to refresh data', 'error');
                btn.disabled = false;
                icon.classList.remove('animate-spin');
                text.textContent = 'Refresh Data';
            }
        }

        // Update Section 2 stage counts in real-time
        function updateSection2StageCounts(oldStatus, newStatus) {
            // Map status to element IDs
            const statusToId = {
                'Selected': 'count-selected',
                'Rejected': 'count-rejected',
                '': 'count-not-reviewed',
                'Not Reviewed': 'count-not-reviewed'
            };

            // Decrease count for old status
            const oldId = statusToId[oldStatus] || 'count-not-reviewed';
            const oldElement = document.getElementById(oldId);
            if (oldElement) {
                let oldCount = parseInt(oldElement.textContent) || 0;
                oldElement.textContent = Math.max(0, oldCount - 1);
            }

            // Increase count for new status
            const newId = statusToId[newStatus] || 'count-not-reviewed';
            const newElement = document.getElementById(newId);
            if (newElement) {
                let newCount = parseInt(newElement.textContent) || 0;
                newElement.textContent = newCount + 1;
            }
        }

        // All sections collapsed by default, load candidates on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved filters from localStorage
            loadFilters();

            // Load candidates (will apply filters automatically)
            loadCandidates();

            // Initialize auto-refresh (checks cutoff date internally)
            initAutoRefresh();
        });
    </script>
</body>
</html>
